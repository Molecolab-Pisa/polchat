\documentclass[a4paper]{report}
\usepackage[british,UKenglish]{babel}
\usepackage[version=3]{mhchem}
\usepackage{bm}
\usepackage{multirow}
\usepackage{mathtools}
\usepackage{framed}
\newcommand{\bs}{\boldsymbol}
\newcommand{\mr}{\mathrm}
%\usepackage{amsmath}
\bibliographystyle{jphysicsB}
\usepackage{sfmath}
\renewcommand{\familydefault}{\sfdefault}
\makeatletter
\newcommand\footnoteref[1]{\protected@xdef\@thefnmark{\ref{#1}}\@footnotemark}
\makeatother

\begin{document}

\Large
\begin{center}
\textbf{PolChat \\ A polarisation-consistent charge-fitting tool}
\end{center}
\normalsize
\begin{center}
\emph{Stefano Caprasecca}\footnote{\texttt{stefano.caprasecca@for.unipi.it}},
\emph{Carles Curutchet, Sandro Jurinovich \& Benedetta Mennucci}
\end{center}

\section*{Version}

This documentation refers to version 3.2.2.

\section*{Presentation}

\texttt{PolChat} is a Molecolab tool\footnote{\texttt{www.dcci.unipi.it/molecolab} ---
For help or to require a copy of the program, please write to
\texttt{benedetta.mennucci@unipi.it}.}. It performs a
polarisable ESP fitting of a given molecule, according to one of the polarisable MM models available, based on the induced dipole formulation.

The next sections describe how to use the tool and the theory behind it.

\section*{Usage}

\subsection*{Generation of input files}

Four files are needed:
\begin{itemize}
\item[\texttt{xxx.gesp}] a \texttt{gesp} file used to get the QM potential to be fit
(generated e.g. by Gaussian);
\item[\texttt{xxx.mol2}] a \texttt{mol2} file used to get connectivity and QM dipole
information (generated by antechamber);
\item[\texttt{xxx.pol}] a file with the values of atomic isotropic polarisabilities,
in a.u.$^3$;
\item[\texttt{xxx.cns}] a file with constraints;
\end{itemize}

The paragraphs below illustrate how to obtain each of these files. Please follow the instructions in
the correct order.

\paragraph*{Generating the \texttt{gesp} file}

This file contains the QM electrostatic potential on a grid of points around the
molecule. It is produced by Gaussian from the following input file \texttt{xxx.com}:

\begin{framed}
\begin{quote}
%\rule{8cm}{1pt}
\begin{verbatim}
#p b3lyp/6-311+G(d,p) pop=ESP IOp(6/50=1)

Calculate ES potential and print it to output file xxx.gesp

0 1
 O  0.0000 0.0000 0.0000
 H  1.0000 0.0000 0.0000
 H  0.0000 1.0000 0.0000

xxx.gesp
\end{verbatim}
%\rule{8cm}{1pt}
\end{quote}
\end{framed}

Additional options one may wish to use are the following:
\begin{itemize}
\item[\texttt{IOp(6/41=$n$)}] use $n$ layers in the ESP fit (default is 4)
\item[\texttt{IOp(6/42=$n$)}] density of points per unit area in the ESP fit (default
is 1)
\end{itemize}

File \texttt{xxx.gesp} is then produced. It contains information on the atom
positions, the QM dipole and the ES potential on the grid points.

\paragraph*{Generating the \texttt{mol2} file}

This file is generated by calling antechamber, which reads the \texttt{gesp} file
produced in the previous step.

Call antechamber:

\begin{framed}
\begin{quote}
%\rule{8cm}{1pt}
\begin{verbatim}
$> antechamber -i xxx.gesp -fi gesp -o xxx.mol2 -fo mol2 

   -c resp -pf yes
\end{verbatim}
%\rule{8cm}{1pt}
\end{quote}
\end{framed}


The \texttt{mol2} file generated contains, among other things, the connectivity
information. The structure of the connectivity is the following:

\begin{framed}
\begin{quote}
\begin{verbatim}
@<TRIPOS>MOLECULE
xxx
   60    59     1     0     0
\end{verbatim}

[...]

\begin{verbatim}
@<TRIPOS>BOND
     1    1    2 1
     2    1   21 1
     3    1   22 1
     4    1   60 1
     5    2    3 2
\end{verbatim}
[...]

\end{quote}
\end{framed}

The first piece on information, at the beginning of the file, and starting with
\texttt{@<TRIPOS>MOLECULE}, lists the number of atoms (60) and the number of bonds
(59). Other bits of information follow.

In the second piece of information, starting with \texttt{@<TRIPOS>BOND}, lists all
(59) bonds; in the example, the 1st bond is between atoms 1 and 2 and is single; the 2nd
bond is between atoms 1 and 21 and is single; and so on.

In some cases you may wish to change the connectivity information. To do so, modify
the list of bonds as you wish, and also update the number of bonds in the first part,
as appropriate.

No further changes are needed. 

\paragraph*{Polarisability file}

The file \texttt{xxx.pol} must be edited by listing all the values of atomic
polarisabilities (in a.u.$^3$), in the same order the atoms appear in the
\texttt{xxx.com} input file. The values can be taken from reference papers. 

At the moment, one model is implemented: the AL model of Wang et al., \emph{J.
Phys. Chem. B} \textbf{115}, 3091 (2011). Work on other models is ongoing. If you need to use one specific model, try contacting the authors.

The said model can be used in two variants, as detailed in the Polarisation Model section.

\paragraph*{Constraint file}

The \texttt{xxx.cns} file contains the constraints you wish to apply to your
fit. Note that the program perform both a standard, non-polarisable ESP fit, and a
polarisable one. Both fits are constrained as requested, including the constraint on
the total dipole moment.

The \texttt{xxx.cns} file \emph{must} contain, \emph{on the first line}, the total
charge of the molecule. Additional constraints are optional.

\begin{itemize}
\item[total charge] (Required) The total charge constraint is \emph{not optional} and must be
entered on the \emph{first line} of the file.
\item[fragment charge] (Optional) It is possible to specify that a certain fragment of the molecule must sum to a certain charge $\overline{c}$. Use the keyword \texttt{fragm}, then on the next line specify the number of atoms belonging to the fragment and the total charge, and on the following line the list of
the atoms of the fragment, for instance:
\begin{framed}
\begin{quote}
\begin{verbatim}
fragm
 4  1.0
 9 15 17 19
\end{verbatim}
\end{quote}
\end{framed}
This requires that the fragment made up by the 4 atoms 9,15,17 and 19 sums up to
charge +1.0.
\item[equivalence] (Optional) The equivalence between atoms is specified using the keyword \texttt{equiv}, followed on the next line by the number of equivalent atoms and on the next line by the list of such atoms, as in the example:
\begin{framed}
\begin{quote}
\begin{verbatim}
equiv
 3
 9 10 11
\end{verbatim}
\end{quote}
\end{framed}
This requires that the three atoms 9, 10 and 11 have the same charge.
\item[total dipole] (Optional) Constraining the total dipole (i.e. the sum of the fixed molecular dipole given by the charge distribution, plus all the induced dipoles) to a certain value can be done by using the keyword \texttt{dipole}. Subkeywords are: 
\begin{itemize}
\item[\texttt{qm}] use the QM molecular dipole as read from Gaussian calculation;
\item[\texttt{esp}] use the dipole computed from the ESP charges as from the \texttt{xxx.gesp} file; 
\item[\texttt{read}] read the dipole moment, in a.u., from the \texttt{xxx.cns} file (on the next line). See examples below.
\end{itemize}
See the examples below:
\begin{framed}
\begin{quote}
\begin{verbatim}
dipole 
qm
\end{verbatim}
\end{quote}
\end{framed}
\begin{framed}
\begin{quote}
\begin{verbatim}
dipole 
esp
\end{verbatim}
\end{quote}
\end{framed}
\begin{framed}
\begin{quote}
\begin{verbatim}
dipole 
read
0.250  -0.375   0.000
\end{verbatim}
\end{quote}
\end{framed}

\item[restraint] (Optional) The presence of a restraint is specified using the
keyword \texttt{restr}, followed by the number of atoms restraind, the restraint 
parameter $a$, and finally the list of atoms, as in the example:
\begin{framed}
\begin{quote}
\begin{verbatim}
restr
 10   0.005
  1  3  5  9 11 12 13 14 15 19
\end{verbatim}
\end{quote}
\end{framed}
This requires that a restraint is applied to the 10 charges specified, following Model 2 of Bayly \emph{et al.}, \emph{J. Phys. Chem,} \textbf{97}, 10269 (1993). A typical value for the parameter is 0.005. Larger values might provide unphysical results.

\end{itemize}

There is no limit on the number of constraints imposed, as long as the conditions are
linearly independent. Only one dipole constraint may be imposed. The order the
conditions are written in the file is irrelevant, except for the total charge,
specified on the first line. See an example of a constraint file below:
\begin{framed}
\begin{quote}
\begin{verbatim}
0.00
dipole
read
0.250   -0.375   0.000
equiv
 3
 1  2  3
fragm
 2  1.0
 5  6
equiv
 2
15 16
equiv
 2
18 19
restr
 10   0.005
  1  3  5  9 11 12 13 14 15 19
\end{verbatim}
\end{quote}
\end{framed}

\subsection*{Running the program}

\paragraph*{Compilation}

The tool is available already compiled for a 64-bit machine.

Should you need other solutions, the authors will be happy to help.

\paragraph*{Running}

Once the program is compiled and the four input files are present, the program can
be executed directly. The input files must be specified when calling the executable,
using the following options:
\begin{itemize}
\item[-g] (required) Followed by the gesp file name
\item[-m] (required) Followed by the mol2 file name
\item[-p] (required) Followed by the polarisability file name
\item[-c] (required) Followed by the constraints file name
\item[-x] (optional) Also include Wang Charge--Polarisability screening. The default is not to include it. Only use if the polarisable MM model includes such screening.
\item[-h] (optional) Print out a help message and quit
\item[-s] (optional) Run in silent mode (minimum printout)
\item[-d] (optional) Run in debug mode (extra printout)
\item[] if neither -s or -d are used, the program will run in normal mode (standard
printout)
\end{itemize}

For instance:
\begin{framed}
\begin{quote}
\begin{verbatim}
$> ./chpol.exe -g xxx.gesp -m xxx.mol2 -p xxx.pol 

   -c xxx.cns -d
\end{verbatim}
\end{quote}
\end{framed}

\section*{Polarisable MM Model}

The program is based on the induced dipole model, following the parametrisation of the AL model of Wang et al., \emph{J. Phys. Chem. B} \textbf{115}, 3091 (2011).

In such model, the charge--dipole interaction is screened. However, please remember that, by default, such interaction is \emph{not} screened. If you wish to activate the screening (consistently with the original model), please use the \texttt{-x} option when executing.

\section*{Theory}

The function to minimize is the squared difference between the QM potential
$\overline{V}$ calculated on a grid and that generated by a set of charges and
dipoles induced by those charges:
\begin{equation}
J = \sum_i^m \left[ \overline{V}_i - V^\mr{chg} - V^\mr{pol} \right]^2 + J_\mr{c} = \sum_i^m
\left[ \overline{V}_i - \sum_j^n \frac{q_j}{r_{ij}} - \sum_j^n \frac{\bs{\mu}_j \cdot
\bs{r}_{ij}}{r_{ij}^3} \right]^2 + J_\mr{c}
\end{equation}
where $i$ runs over the $m$ grid points, $j$ over the $n$ MM atoms,
$\bs{r}_{ij}\equiv\bs{r}_i - \bs{r}_j$ and $J_\mr{c}$ is an additional term
eventually including the constraints (see later).

\subsection*{Main function}

The minimum of this function is obtained by setting to zero the derivative with
respect to the charges:
\begin{equation}
\label{deriv}
\frac{\partial J}{\partial q_x} = - \sum_i^m 2 \left[ \overline{V}_i - V^\mr{chg} -
V^\mr{pol} \right] \left[ \frac{\partial}{\partial q_x} \left(\sum_j^n
\frac{q_j}{r_{ij}}\right) + \frac{\partial}{\partial q_x} \left(\sum_j^n
\frac{\bs{\mu}_j \cdot \bs{r}_{ij}}{r_{ij}^3} \right)\right]
\end{equation}

Some definitions:
\begin{align}
A_{ij} &\equiv \frac{1}{r_{ij}} \\
\bs{B}_{ij} &\equiv \frac{\bs{r}_{ij}}{r_{ij}^3} \\
\bs{C}_{ij} &\equiv \sum_k^n D^{-1}_{ik}\bs{B}_{kj} \\
E_{ij} &\equiv \sum_j^n \bs{B}_{ik} \bs{C}_{kj} \\
F_{ij} &\equiv A_{ij} + E_{ij} \\
G_{ij} &\equiv \sum_k^m F_{ik}^\dagger F_{kj} \\
H_i &= \sum_j^m F_{ij}^\dagger \overline{V}_j 
\end{align}

So:
\begin{align}
\sum_j^n \frac{q_j}{r_{ij}} =& \sum_j^n A_{ij} q_j \\
\bs{\Phi}_k =& \sum_l^n \frac{q_l \bs{r}_{kl}}{r_{kl}^3} = \sum_l^n \bs{B}_{kl} q_l \\
\bs{\mu}_j =& \sum_k^n \bs{D}^{-1}_{jk} \bs{\Phi}_k = \sum_k^n \sum_l^n
\bs{D}^{-1}_{jk} \bs{B}_{kl} q_l = \sum_l^n \bs{C}_{jl} q_l \\
\sum_j^n \frac{\bs{\mu}_j \cdot \bs{r}_{ij}}{r_{ij}^3} =& \sum_j^n \bs{B}_{ij}
\bs{\mu}_j = \sum_j^n \sum_l^n \bs{B}_{ij} \bs{C}_{jl} q_l = \sum_l^n E_{il} q_l
\end{align}
and the derivatives become:
\begin{align}
\frac{\partial}{\partial q_x} \left(\sum_j^n \frac{q_j}{r_{ij}}\right) =&
\frac{\partial}{\partial q_x} \left(\sum_j^n A_{ij} q_j\right) = A_{ix} \\
\frac{\partial}{\partial q_x} \left(\sum_j^n \frac{\bs{\mu}_j \cdot
\bs{r}_{ij}}{r_{ij}^3} \right) =& \frac{\partial}{\partial q_x} \left(\sum_j^n E_{ij}
q_j \right) = E_{ix}
\end{align}

Therefore equation \ref{deriv} becomes:
\begin{align}
\frac{\partial J}{\partial q_x} =& - 2 \sum_i^m \left[ \overline{V}_i - \sum_j^n
A_{ij} q_j - \sum_j^n E_{ij} q_j \right] \left[ A_{ix} + E_{ix} \right] = \nonumber \\
\label{E:A}
=& -2\sum_i^m \left[ \overline{V}_i - \sum_j^n F_{ij} q_j\right] F_{ix}
\end{align}

Setting this to zero to obtain the minimizing charges gives:
\begin{align}
\label{E:B}
&\sum_i^m \left[\overline{V}_i - \sum_j^n F_{ij} q_j \right] F_{ix} = 0 \\
&\sum_i^m \sum_j^n F_{xi}^\dagger F_{ij} q_j = \sum_i^m F_{ix} \overline{V}_i \\
\label{E:C}
&\sum_j^n G_{xj} q_j = H_x
\end{align}

This can be rewritten in matrix form as:
\begin{equation}
\bs{G} \bs{q} = \bs{H}
\end{equation}
and the system is solved by:
\begin{equation}
\bs{q} = \bs{G}^{-1} \bs{H}
\end{equation}

\subsection*{Constraints}

Constraints are introduced in function $J_\mr{c}$. These are of four different kinds:
total charge of a fragment, equivalence between $n$ atoms, restraint and conservation of the total dipole moment. The conservation of the total molecular charge is a particular
case of the first kind.

\paragraph{Charge of a fragment}

The total charge of a fragment $F$ is set to $\overline{q}$. Therefore the constraint
function is:
\begin{equation}
J_\mr{c} = \lambda\left(\sum_{j\in F} q_j - \overline{q} \right) 
\end{equation}

It follows that:
\begin{align}
&\frac{\partial}{\partial q_x} J_\mr{c} = \lambda q_x \\
&\frac{\partial}{\partial \lambda} J_\mr{c} = \sum_{j\in F} q_j - \overline{q}
\end{align}

If the fragment comprises atoms from $r$ to $s$, the new matrices are:
\begin{equation}
\bs{G}_c = \left[ \begin{array}{ccccccccc} 
G_{1,1} & G_{1,2} & \cdots & G_{1,r} & \cdots & G_{1,s} & \cdots & G_{1,n} & 0 \\
G_{2,1} & G_{2,2} & \cdots & G_{2,r} & \cdots & G_{2,s} & \cdots & G_{2,n} & 0 \\
\vdots  &         &        &         &        &         &        &         & 0 \\
G_{r,1} & G_{r,2} & \cdots & G_{r,r} & \cdots & G_{r,s} & \cdots & G_{r,n} & 1 \\
\vdots  &         &        &         &        &         &        &         & 1 \\
G_{s,1} & G_{s,2} & \cdots & G_{s,r} & \cdots & G_{s,s} & \cdots & G_{s,n} & 1 \\
\vdots  &         &        &         &        &         &        &         & 0 \\
G_{n,1} & G_{n,2} & \cdots & G_{n,r} & \cdots & G_{n,s} & \cdots & G_{n,n} & 0 \\
0       & 0       & 0      & 1       & 1      & 1       & 0      & 0       & 0 \\
\end{array} \right] \hspace{0.3cm} \bs{H}_\mr{c} = \left[ \begin{array}{c} H_1 \\ H_2 \\ \vdots \\ H_r \\ \vdots \\ H_s \\ \vdots \\ H_n \\ \overline{q} \end{array} \right]
\end{equation}

The same holds even in the general case when the fragment comprises non-sequential
atoms.

\paragraph{Equivalence of atoms}

If condition $q_i = q_j = q_k \dots$ holds, this can be split into a system of
equations:
\begin{align}
J_{\mr{c}1} = \lambda_1 \left( q_i - q_j \right) \nonumber \\
J_{\mr{c}2} = \lambda_2 \left( q_j - q_k \right) \nonumber 
\end{align}
and so on. For each condition:
\begin{align}
&\frac{\partial}{\partial q_x} J_{\mr{c}1} = \lambda (\delta_{i,x} - \delta_{j,x}) \\
&\frac{\partial}{\partial \lambda_1} J_{\mr{c}1} = q_i - q_j
\end{align}
and the new matrices are:
\begin{equation}
\bs{G}_c = \left[ \begin{array}{ccccccccr} 
G_{1,1} & G_{1,2} & \cdots & G_{1,i} & \cdots & G_{1,j} & \cdots & G_{1,n} & 0 \\
G_{2,1} & G_{2,2} & \cdots & G_{2,i} & \cdots & G_{2,j} & \cdots & G_{2,n} & 0 \\
\vdots  &         &        &         &        &         &        &         & 0 \\
G_{i,1} & G_{i,2} & \cdots & G_{i,i} & \cdots & G_{i,j} & \cdots & G_{i,n} & 1 \\
\vdots  &         &        &         &        &         &        &         & 0 \\
G_{j,1} & G_{j,2} & \cdots & G_{j,i} & \cdots & G_{j,j} & \cdots & G_{j,n} & -1 \\
\vdots  &         &        &         &        &         &        &         & 0 \\
G_{n,1} & G_{n,2} & \cdots & G_{n,i} & \cdots & G_{n,j} & \cdots & G_{n,n} & 0 \\
0       & 0       & 0      & 1       & 0      & -1      & 0      & 0       & 0 \\
\end{array} \right] \hspace{0.3cm} \bs{H}_\mr{c} = \left[ \begin{array}{c} H_1 \\ H_2
\\ \vdots \\ H_i \\ \vdots \\ H_j \\ \vdots \\ H_n \\ 0 \end{array}
\right]
\end{equation}

\paragraph{Restraint}

If the charges are restrained using a restraint parameter, an extra function is added
so that large absolute values of charges are discouraged. The extra function is:
\begin{equation}
J_\mr{c} = a \sum_{j \in \mr{restr}} q_j^2
\end{equation}
This function corresponds to that used in Model 2 of Bayly \emph{et al.}, \emph{J.
Phys. Chem.} \textbf{97}, 10269 (1993). Note that a hyperbolic penalty function
provided better results than the parabolic one, but the latter has linear derivatives
in the charges and does not therefore require an iterative solution.

The derivative of the constrained function is:
\begin{equation}
\frac{\partial}{\partial q_x} J_\mr{c} = 2 a q_x
\end{equation}
if the $x$-th atom is among those to constrain. A diagonal term must be added to $\bs{G}$ of Equation(\ref{E:C})\footnote{Note that the 2 factor is cancelled when passing from Eq.(\protect\ref{E:A}) to Eq.(\protect\ref{E:B}).}:
\begin{equation}
\bs{G}_\mr{c} = \bs{G} + a \bs{1}^\mr{restr}
\end{equation}
where 
\begin{equation}
\bs{1}^\mr{restr}_{i,j} = \left\{\begin{array}{ll} 1 & i=j\in\mr{restr} \\ 0 & \mr{otherwise} \end{array}\right.
\end{equation}

\paragraph{Conservation of the total dipole moment}

If the total dipole moment must be equal to $\overline{\bs{\mu}}$, this corresponds
to three conditions:
\begin{equation}
J_\mr{c} = \lambda \left(\sum_j \bs{\mu}_j + \bs{\mu}^\mr{chg} - \overline{\bs{\mu}}
\right) 
\label{E:ref}
\end{equation}
where $\bs{\mu}_j$ are the induced atomic dipole moments and $\bs{\mu}^\mr{chg}$ is the
fixed dipole given by the charges. Note that when non-polarisable ESP charges are
being calculated, the induced dipole moments are assumed to be zero. In such case,
the equations below still hold, with $\bs{C}_{jk} = 0$ and $\tilde{\bs{C}}_k = 0$,
and therefore with $\bs{K}_k = \bs{r}_k$. Equation \ref{E:ref} can be rewritten as:
\begin{align}
J_\mr{c} =& \lambda \left(\sum_j \left(\sum_k \bs{C}_{jk} q_k + 
\bs{r}_j q_j\right) - \overline{\bs{\mu}} \right) = \nonumber \\
=& \lambda \left(\sum_k \left( \tilde{\bs{C}}_k q_k + \bs{r}_k q_k \right)-
\overline{\bs{\mu}} \right) = \lambda \left(\sum_k \bs{K}_k q_k -
\overline{\bs{\mu}} \right)
\end{align}
where $\tilde{\bs{C}}_k \equiv \sum_j \bs{C}_{jk}$ and $\bs{K}_k \equiv
\tilde{\bs{C}}_k + \bs{r}_k$. The derivatives are:
\begin{align}
&\frac{\partial}{\partial q_x} J_\mr{c} = \lambda \bs{K}_x \\
&\frac{\partial}{\partial \lambda} J_\mr{c} = \sum_k \bs{K}_k q_k -
\overline{\bs{\mu}}
\end{align}

The new matrices are:
\begin{equation}
\bs{G}_c = \left[ \begin{array}{ccccccccr} 
G_{1,1}   & G_{1,2}   & \cdots & G_{1,n}   & K_1^{(x)} & K_1^{(y)} & K_1^{(z)} \\
G_{2,1}   & G_{2,2}   & \cdots & G_{2,n}   & K_2^{(x)} & K_2^{(y)} & K_2^{(z)} \\
\vdots \\
G_{n,1}   & G_{n,2}   & \cdots & G_{n,n}   & K_n^{(x)} & K_n^{(y)} & K_n^{(z)} \\
K_1^{(x)} & K_2^{(x)} & \cdots & K_n^{(x)} & 0         & 0         & 0         \\
K_1^{(y)} & K_2^{(y)} & \cdots & K_n^{(y)} & 0         & 0         & 0         \\
K_1^{(z)} & K_2^{(z)} & \cdots & K_n^{(z)} & 0         & 0         & 0         \\
\end{array} \right] \hspace{0.3cm} \bs{H}_\mr{c} = \left[ \begin{array}{c} H_1 \\ H_2
\\ \vdots \\ H_n \\ \overline{\bs{\mu}}^{(x)} \\
\overline{\bs{\mu}}^{(x)} \\ \overline{\bs{\mu}}^{(x)} \end{array}
\right]
\end{equation}

\section*{Download}

The binary code can be downloaded free of charge from the Molecolab website:
\texttt{www.dcci.unipi.it/molecolab/tools}.

Please contact the authors for comments or questions.

\section*{Citation}

Please cite this tool as: 

\indent PolChat: A polarisation-consistent charge fitting tool. \\
\indent S. Caprasecca, C. Curutchet, S. Jurinovich \& B. Mennucci. \\
\indent Molecolab Tools. 2014-2015 \texttt{www.dcci.unipi.it/molecolab/tools}

\end{document}
